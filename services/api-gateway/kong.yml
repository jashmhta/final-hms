# API Gateway Configuration using Kong
# Enterprise-grade API Gateway for HMS Microservices

_format_version: "1.1"
_transform: true

# Services Configuration
services:
  # Patient Service
  - name: patient-service
    url: http://patient-service:8000
    routes:
      - name: patient-route
        paths:
          - /api/patients
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
          exposed_headers:
            - X-RateLimit-Limit
            - X-RateLimit-Remaining
            - X-RateLimit-Reset
      - name: rate-limiting
        config:
          minute: 1000
          hour: 10000
          day: 100000
      - name: jwt
        config:
          key_claim_name: iss
          secret_is_base64: false
          run_on_preflight: true
      - name: request-termination
        config:
          status_code: 429
          message: "Rate limit exceeded"

  # Authentication Service
  - name: auth-service
    url: http://auth-service:8001
    routes:
      - name: auth-route
        paths:
          - /api/auth
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
      - name: request-validator
        config:
          body_schema: |
            {
              "$schema": "http://json-schema.org/draft-04/schema#",
              "type": "object",
              "properties": {
                "username": {"type": "string", "minLength": 3},
                "password": {"type": "string", "minLength": 8}
              },
              "required": ["username", "password"]
            }

  # Appointment Service
  - name: appointment-service
    url: http://appointment-service:8002
    routes:
      - name: appointment-route
        paths:
          - /api/appointments
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 500
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - doctor
            - nurse
            - staff
            - admin

  # Clinical Service (EHR)
  - name: clinical-service
    url: http://clinical-service:8003
    routes:
      - name: clinical-route
        paths:
          - /api/clinical
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 200
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - doctor
            - nurse
            - admin
      - name: request-transformer
        config:
          add:
            headers:
              - "X-HIPAA-Audit: true"

  # Billing Service
  - name: billing-service
    url: http://billing-service:8004
    routes:
      - name: billing-route
        paths:
          - /api/billing
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 300
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - admin
            - staff

  # Pharmacy Service
  - name: pharmacy-service
    url: http://pharmacy-service:8005
    routes:
      - name: pharmacy-route
        paths:
          - /api/pharmacy
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 200
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - doctor
            - nurse
            - pharmacist
            - admin

  # Laboratory Service
  - name: lab-service
    url: http://lab-service:8006
    routes:
      - name: lab-route
        paths:
          - /api/lab
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 200
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - doctor
            - nurse
            - lab_tech
            - admin

  # Radiology Service
  - name: radiology-service
    url: http://radiology-service:8007
    routes:
      - name: radiology-route
        paths:
          - /api/radiology
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 200
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - doctor
            - radiologist
            - admin

  # Analytics Service
  - name: analytics-service
    url: http://analytics-service:8008
    routes:
      - name: analytics-route
        paths:
          - /api/analytics
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 100
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - admin
            - analyst

  # Notification Service
  - name: notification-service
    url: http://notification-service:8009
    routes:
      - name: notification-route
        paths:
          - /api/notifications
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 500
      - name: jwt
        config:
          key_claim_name: iss

  # Audit Service
  - name: audit-service
    url: http://audit-service:8010
    routes:
      - name: audit-route
        paths:
          - /api/audit
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 100
      - name: jwt
        config:
          key_claim_name: iss
      - name: acl
        config:
          allow:
            - admin
            - auditor

  # File Service
  - name: file-service
    url: http://file-service:8011
    routes:
      - name: file-route
        paths:
          - /api/files
        strip_path: true
    plugins:
      - name: cors
        config:
          origins:
            - "*"
      - name: rate-limiting
        config:
          minute: 1000
      - name: jwt
        config:
          key_claim_name: iss
      - name: request-size-limiting
        config:
          allowed_payload_size: 50

# Global Plugins
plugins:
  - name: prometheus
    config:
      per_consumer: true
  - name: zipkin
    config:
      http_endpoint: http://jaeger:9411/api/v2/spans
      sample_ratio: 1.0
  - name: http-log
    config:
      http_endpoint: http://logstash:8080
      method: POST
      timeout: 1000
      keepalive: 1000
      flush_timeout: 2
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid#counter
      echo_downstream: false

# Upstreams Configuration
upstreams:
  - name: patient-service-upstream
    targets:
      - target: patient-service:8000
        weight: 100
    healthchecks:
      active:
        timeout: 5
        unhealthy:
          interval: 10
          http_failures: 3
        healthy:
          interval: 5
          successes: 2
      passive:
        type: http
        healthy:
          successes: 2
          http_statuses:
            - 200
            - 201
            - 202
            - 204
        unhealthy:
          http_failures: 3
          http_statuses:
            - 429
            - 500
            - 501
            - 502
            - 503
            - 504
            - 505

  - name: auth-service-upstream
    targets:
      - target: auth-service:8001
        weight: 100
    healthchecks:
      active:
        timeout: 5
        unhealthy:
          interval: 10
          http_failures: 3
        healthy:
          interval: 5
          successes: 2

# Consumers and Credentials
consumers:
  - username: admin
    custom_id: admin_001
    plugins:
      - name: jwt
        config:
          key: "admin-jwt-secret"
          algorithm: "HS256"
      - name: acl
        config:
          groups:
            - admin
            - super_admin

  - username: doctor
    custom_id: doctor_001
    plugins:
      - name: jwt
        config:
          key: "doctor-jwt-secret"
          algorithm: "HS256"
      - name: acl
        config:
          groups:
            - doctor

  - username: nurse
    custom_id: nurse_001
    plugins:
      - name: jwt
        config:
          key: "nurse-jwt-secret"
          algorithm: "HS256"
      - name: acl
        config:
          groups:
            - nurse

  - username: patient
    custom_id: patient_001
    plugins:
      - name: jwt
        config:
          key: "patient-jwt-secret"
          algorithm: "HS256"
      - name: acl
        config:
          groups:
            - patient

# ACL Groups
acls:
  - consumer: admin
    group: admin
  - consumer: admin
    group: super_admin
  - consumer: doctor
    group: doctor
  - consumer: nurse
    group: nurse
  - consumer: patient
    group: patient

# Rate Limiting Policies
rate_limiting:
  - name: global-limit
    config:
      minute: 10000
      hour: 100000
      day: 1000000
      limit_by: ip

# Service Discovery Configuration
# This will be managed dynamically by Kong Admin API